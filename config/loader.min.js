var Loader={files:{},selected_file:"index.mustache",insert_content_timer:void 0,insert_content_callback_timer:void 0,init:function(){this.hashChange()
var e=this
window.onhashchange=function(){console.log("hash change"),e.hashChange(),e.insertContent()},this.requestData(),this.loadFile(this.selected_file),this.loadFilenames(),ws_receive_callbacks.push(function(t){e.insertContent(t)})},hashChange:function(){console.log(window.location.hash)
var e=window.location.hash,t=e.indexOf("filename=")
if(t>0){t+="filename=".length
var n=e.indexOf("&")
n<0&&(n=e.length),this.selected_file=e.substring(t,n)}},loadFile:function(e){console.log("loadFile("+e+")")
var t=new XMLHttpRequest,n=this
t.addEventListener("load",function(){n.fileCallback(this,n,e)}),t.open("GET",e),t.send()},loadFilenames:function(){this.loadFile("filenames.sys")},fileCallback:function(e,t,n){if("filenames.sys"===n){var i=document.getElementById("files")
i.innerHTML=""
for(var s=e.responseText.split("\r\n"),a=0;a<s.length;a++){var n=s[a],o=n.split(".")
if("mustache"===o[o.length-1]){var l=document.createElement("a"),r=document.createTextNode(n)
l.appendChild(r),l.setAttribute("href","#filename="+n),i.appendChild(l),i.appendChild(document.createElement("br")),void 0===t.files[n]&&(t.files[n]={})}}t.loadRemainingFiles()}else void 0===t.files[n]&&(t.files[n]={}),t.files[n].filename=n,t.files[n].raw=e.responseText,t.files[n].tag_root=new Tag,Parser.init(t.files[n].tag_root),Parser.parse(t.files[n].raw),console.log(n,t.files[n]),n===t.selected_file&&t.insertContent()},loadRemainingFiles:function(){for(var e=Object.getOwnPropertyNames(this.files),t=0,n=0;n<e.length;n++){var i=e[n],s=i.split(".")
if("mustache"===s[s.length-1]&&void 0===this.files[i].raw){t++,this.loadFile(i)}}},insertContent:function(){if(void 0!==this.insert_content_timer&&Date.now()-this.insert_content_timer<1e3)return window.clearTimeout(this.insert_content_callback_timer),void(this.insert_content_callback_timer=window.setTimeout(this.insertContent.bind(this),1e3))
this.insert_content_timer=Date.now()
var e=this.selected_file
if(void 0===this.files[e]||void 0===this.files[e].raw)return void console.log(e+" not loaded yet")
console.log("insertContent("+e+")",ws_data)
var t=this.files[e].raw.split("\n"),n=this.files[e].tag_root.children,i=[]
this.contentChunk(n,0,0,t,i,[],t.length-1,t[t.length-1].length)
var s=document.getElementById("content")
s.innerHTML=""
for(var a=document.createElement("div"),o="",l=0;l<i.length;l++)o+=i[l]
a.innerHTML=o,s.appendChild(a)
var l},getFullPath:function(e,t){t=t.split(".")
for(var n,i=e.length;i>=0&&(n=e.slice(0,i).concat(t),!function(e){for(var t=ws_data,n=0;n<e.length;n++){if(t instanceof Array&&(t=t[0]),void 0===t)return!1
var i=e[n]
if(e[n].endsWith("_path")&&(i=e[n].substring(0,e[n].lastIndexOf("_"))),void 0===(t=t[i]))return!1}return!0}(n));i--);return n},contentChunk:function(e,t,n,i,s,a,o,l,r){void 0===r&&(r=[])
for(var h=0;h<e.length;h++){var c=e[h]
path=this.getFullPath(a,c.name)
for(var d=c.line,f=t;f<d;f++)0===n&&s.push(""),s[s.length-1]+=i[f].substring(n,i[f].length),n=0,t=f
if(t!==d&&s.push(""),t=d,s[s.length-1]+=i[d].substring(n,c.pos),n=c.pos+c.name.length,"name"===c.type)s[s.length-1]+=this.tagContent(path,r),n+=4
else if("contains"===c.type){n+=5
var u=this.tagContent(path,r)
u instanceof Array||(u="0"===u||""===u||"n"===u||"N"===u?[]:[!0])
var v={}
if(0===u.length){var g=e[h+1]
void 0!==g&&void 0!==g.line&&void 0!==g.pos&&(v.line=g.line,v.pos=g.pos)}for(var p=0;p<u.length;p++){var m=t,_=n,w=e[h+1]
path=a.concat(c.name.split(".")),v=this.contentChunk(c.children,m,_,i,s,path,w.line,w.pos,r.concat(p)),m=v.line,_=v.pos,s.push("")}t=v.line,n=v.pos}else if("not"===c.type){n+=5
var u=this.tagContent(path,r)
if(0===u.length||"0"===u||""===u){var v={line:t,pos:n},m=t,_=n,w=e[h+1]
path=a.concat(c.name.split(".")),v=this.contentChunk(c.children,m,_,i,s,path,w.line,w.pos,r.concat(0)),s.push(""),t=v.line,n=v.pos}else{var g=e[h+1]
void 0!==g&&(t=g.line,n=g.pos)}}else n+=5}for(var f=t;f<o;f++)0===n&&s.push(""),s[s.length-1]+=f===o?i[f].substring(n,l):i[f].substring(n,i[f].length),n=0
return{line:o,pos:n}},tagContent:function(e,t){for(var n=ws_data,i=0,s="",a=0;a<e.length;a++){if(n instanceof Array&&(n=n[t[i]],s+=t[i],s+=".",i++),s+=e[a],s+=".",void 0===n||void 0===n[e[a]])return s.endsWith("_path.")&&s.split("_path.").length>1?s.split("_path.")[0]:"(XXXX)"
n=n[e[a]]}return n},requestData:function(){var e={_subject:"hosts/_all",_command:"learn_all"}
wsQueueSend(e)},saveChanges:function(){for(var e=document.getElementsByClassName("monitor_changes"),t=0;t<e.length;t++){var n=e[t].name
if(void 0===n||""===n)for(var i=0;i<e[t].classList.length;i++)if("monitor_changes"!==e[t].classList[i]){n=e[t].classList[i]
break}var s=e[t].value
if("checkbox"===e[t].type&&(s=1*e[t].checked),void 0!==s&&void 0!==valueAtPath(n)&&""+s!==valueAtPath(n)){var a
try{a=ws_data.host.mqtt.publish_prefix,a+="/hosts/",a+=ws_data.host.hostname}catch(e){a=""}var o={_subject:a,_command:"update",path:n,value:s}
wsQueueSend(o),console.log(n,valueAtPath(n),s,e[t].type)}}}}
window.addEventListener("load",function(){wsInit(),Loader.init()},!1)

function wsCodes(e){return["CONNECTING","OPEN","CLOSING","CLOSED"][e]}function parsePayload(e,s){var t=e.split(":",1)[0]
e=e.slice(e.indexOf(":")+1)
var o
try{o=JSON.parse(e),s&&!o._ack&&(s.innerHTML+="<p style='color: blue;'>> JSON received: "+e+"</p>")}catch(t){return void(s&&(s.innerHTML+="<p style='color: black;'>> text received: "+e+"</p>"))}return o.topic=t,o}function setIo(){console.log(this)
var e={_command:!Boolean(parseInt(this.value)),_subject:this.topic}
console.log(e),wsQueueSend(e)}function updatePage(e){var s=""
if(e._iopin){s="ws_iopin_"+e._iopin+"_zero"
for(var t=0;t<document.getElementsByClassName(s).length;t++){var o=document.getElementsByClassName(s)[t]
"0"===e._state?(o.classList.add("io_visible"),o.classList.remove("io_hidden")):(o.classList.add("io_hidden"),o.classList.remove("io_visible"))}s="ws_iopin_"+e._iopin+"_positive"
for(var t=0;t<document.getElementsByClassName(s).length;t++){var o=document.getElementsByClassName(s)[t]
"0"!==e._state?(o.classList.add("io_visible"),o.classList.remove("io_hidden")):(o.classList.add("io_hidden"),o.classList.remove("io_visible"))}s="ws_iopin_"+e._iopin+"_value"
for(var t=0;t<document.getElementsByClassName(s).length;t++){var o=document.getElementsByClassName(s)[t]
o.innerHTML=e._state}s="ws_iopin_"+e._iopin+"_set_toggle"
for(var t=0;t<document.getElementsByClassName(s).length;t++){var o=document.getElementsByClassName(s)[t]
o.style.cursor="pointer",o.onclick=setIo.bind({topic:o.getAttribute("topic"),value:e._state})}}}function updateHealth(){for(var e="ws_health",s=0;s<document.getElementsByClassName(e).length;s++){var t=document.getElementsByClassName(e)[s],o=Date.now()-ws_data_timer
t.innerHTML=Math.round(o/100)/10,t.style["background-color"]=o>=MAX_TIME?"red":o>=MAX_TIME/2?"orange":"white"}e="ws_state"
for(var s=0;s<document.getElementsByClassName(e).length;s++){var t=document.getElementsByClassName(e)[s],o=Date.now()-ws_data_timer
t.innerHTML=!websocket||wsCodes(websocket.readyState),"OPEN"===t.innerHTML?t.style["background-color"]="green":"CONNECING"===t.innerHTML?t.style["background-color"]="orange":t.style["background-color"]="red"}}function wsCleanup(){websocket&&(console.log("wsCleanup()"),websocket.close(),websocket.onclose=null,websocket=null)}function wsStart(){if(!(Date.now()-ws_start_timer<MAX_TIME)){console.log("wsStart()"),ws_start_timer=Date.now(),wsCleanup(),log&&(log.innerHTML+="<p>> New WS</p>"),console.log("new ws")
var e="ws://"+location.hostname+":81"
try{websocket=new WebSocket(e)}catch(e){return console.log(e),void wsCleanup()}websocket.onopen=function(){console.log("websocket.onopen"),ws_data_timer=Date.now(),log&&(log.innerHTML+="<p>> WS Connected</p>")
wsQueueSend({_command:"solicit",_subject:"homeautomation/0/_all/_all"})},websocket.onmessage=function(e){ws_data_timer=Date.now()
var s=parsePayload(e.data,log)
if(void 0!==s&&(updatePage(s),"teach"===s._command)){wsDeQueue(s)
var t=ws_data,o=s.name.split(".")
console.log(o.join("."))
for(var n=0;n<o.length;n++){var a,r=o[n]
parseInt(o[n+1],10).toString()===o[n+1]?(a=parseInt(o[n+1],10),n++):a=void 0,n<o.length-1?"object"!=typeof t[r]&&(t[r]=void 0===a?{}:[]):void 0!==t[r]&&"string"!=typeof t[r]||(t[r]=s.content),void 0===a?t=t[r]:(t.hasOwnProperty(r)||(t[r]=[]),t[r].hasOwnProperty(a)||(t[r][a]={}),t=t[r][a])}localStorage.esp8266_kitchensink=JSON.stringify(ws_data)
for(var i=0;i<ws_receive_callbacks.length;i++)ws_receive_callbacks[i](o)
wsQueueSend({_command:"ack",path:s.name,id:s.id,_subject:"hosts/_all"})}},websocket.onerror=function(e){console.log("websocket.onerror",e),log&&(log.innerHTML+="<p style='color: red;'>> WS ERROR: "+e.data+"</p>")},websocket.onclose=function(e){console.log("websocket.onclose",e),log&&(log.innerHTML+="<p style='color: red;'>> WS closed: "+e.code+"</p>")}}}function wsCheck(){websocket&&websocket.readyState===WebSocket.OPEN&&Date.now()-ws_data_timer>=KEEPALIVE_TIME&&(counter+=1,websocket.send('{"_ping":"'+counter+'"}')),websocket&&websocket.readyState!==WebSocket.CLOSED&&websocket.readyState!==WebSocket.CLOSING||wsStart(),websocket&&websocket.readyState===WebSocket.OPEN&&Date.now()-ws_data_timer>MAX_TIME&&(console.log("wsCheck() fail"),log&&(log.innerHTML+="<p style='color: red;'>> WS timeout</p>"),wsStart()),updateHealth()}function wsInit(){console.log("wsInit()"),log=document.getElementById("log"),log&&(log.innerHTML="Log:"),ws_data_timer=Date.now(),wsStart(),window.setInterval(wsCheck,KEEPALIVE_TIME)}function wsQueueSend(e){void 0!==e&&(void 0===e.name?wsMessages[JSON.stringify(e)]=e:wsMessages[e.name]=e),void 0===wsMessagesTimer&&wsSend()}function wsSend(){if(0===Object.getOwnPropertyNames(wsMessages).length)return clearTimeout(wsMessagesTimer),void(wsMessagesTimer=void 0)
if(websocket.readyState!==WebSocket.OPEN)return clearTimeout(wsMessagesTimer),wsMessagesTimer=setTimeout(wsSend,1e3),wsCheck(),void console.log("  websocket not open. TODO: reopen?")
var e
try{var s=Object.getOwnPropertyNames(wsMessages)[0]
e=wsMessages[s],websocket.send(JSON.stringify(e)),log&&(log.innerHTML+="<p style='color: green;'>> WS publish: "+JSON.stringify(e)+"</p>"),"learn"!==e._command&&"update"!==e._command&&wsDeQueue(e)}catch(e){console.log(e)}clearTimeout(wsMessagesTimer),wsMessagesTimer=setTimeout(wsSend,1e3)}function wsDeQueue(e){var s
s=void 0===e.name?JSON.stringify(e):e.name,void 0!==wsMessages[s]&&(delete wsMessages[s],wsSend())}function valueAtPath(e){e=e.split(".")
for(var s=ws_data,t=0;t<e.length;t++){if(!s[e[t]])return
s=s[e[t]]}if(s instanceof Array)for(var t=0;t<s.length;t++)if("1"===s[t].selected){s=s[t].value
break}return s}var log,websocket=null,ws_data_timer,ws_start_timer,MAX_TIME=1e4,KEEPALIVE_TIME=2e3,counter=0,wsMessages={},wsMessagesTimer,ws_receive_callbacks=[],ws_data={}
""===localStorage.esp8266_kitchensink&&(localStorage.esp8266_kitchensink="{}")
